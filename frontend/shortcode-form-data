<?php

function handle_delusion_calculator_form()
{
    // Check if form is submitted
    if ($_SERVER["REQUEST_METHOD"] == "POST") {
        // Retrieve form data
        $gender = isset($_POST['men']) ? 'Male' : 'Female';
        $ageRangeMin = $_POST['ageMin'];
        $ageRangeMax = $_POST['ageMax'];
        $minIncome = $_POST['minIncome'];
        $maxIncome = $_POST['maxIncome'];
        $ethnicity = $_POST['ethnicity'];
        $excludeObese = isset($_POST['obese']) ? 'Yes' : 'No';
        $excludeMarried = isset($_POST['married']) ? 'Yes' : 'No';
        $minHeight = $_POST['heightMin'];
        $maxHeight = $_POST['heightMax'];

        $Height = "<p>Height Range: " . floor($minHeight / 12) . "'" . ($minHeight % 12) . " - " . floor($maxHeight / 12) . "'" . ($maxHeight % 12) . "</p>";



        // Display the submitted values
        // echo "<h2>Form Submitted Successfully</h2>";
        // echo "<p>Gender: $gender</p>";
        // echo "<p>Age Range: $ageRangeMin - $ageRangeMax</p>";
        // echo "<p>Minimum Income: $$minIncome K - Maximum Income: $$maxIncome K</p>";
        // echo "<p>Ethnicity: $ethnicity</p>";
        // echo "<p>Exclude Obese: $excludeObese</p>";
        // echo "<p>Exclude Married: $excludeMarried</p>";
        // echo "<p>Height Range:" . $Height . "</p>";

        $test_data = [
            'age_range' => [$ageRangeMin, $ageRangeMax],  // Age range between 25 and 35
            'income_slider' => $minIncome * 1000,   // Minimum income of $75,000
            'race' => ucfirst($ethnicity),  // Selected races: White and Asian
            'height_feet' => floor($minHeight / 12),
            'height_inches' => ($minHeight % 12),
            'gender_preference' => $gender, // Optional: Male partner preference
            'exclude_obese' => $excludeObese,    // Optional: Exclude obese individuals
        ];

        $results = calculate_dating_pool($test_data);
        $american_population = $gender == 'Male' ? array('gender' => 'men', 'population' => 164977341) : array('gender' => 'women', 'population' => 168310216);

        $percentage = $results["percentage"] / 100; // Convert percentage to decimal

        $matched_population = round($american_population['population'] * $percentage);

        ob_start(); ?>

        <html>

        <head>

            <script src="https://cdn.tailwindcss.com"></script>
            <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css"
                integrity="sha512-SnH5WK+bZxgPHs44uWIX+LLJAJ9/2PkPKZ5QiAj6Ta86w+fsb2TkcmfRyVX3pBnMFcV7oQPJkl9QevSCWr3W6A=="
                crossorigin="anonymous" referrerpolicy="no-referrer" />
            <link rel="stylesheet"
                href="http://wp.docker.localhost:8000/wp-content/plugins/hamja-delusion-calculator/frontend/range.css" />

            <style>
            </style>

        </head>

        <body>

            <div class="flex items-center justify-center flex-col space-y-4">
                <h1 style="font-size:80px"> <?php echo $results["percentage"] ?> %</h1>
                <p>of all <?php echo $american_population['gender'] ?> in the United States meet your standards</p>
                <p>Thatâ€™s <?php echo number_format($matched_population) ?> of
                    <?php echo number_format($american_population['population']) ?> American
                    <?php $american_population['gender'] ?>
                </p>
                <div>
                    <?php
                    $people_no = floor($results['percentage']);

                    $random = array();

                    if ($people_no > 0) {
                        for ($i = 0; $i <= $people_no; $i++) {
                            array_push($random, rand(50, 350));
                        }
                    }

                    for ($i = 0; $i <= 420 - 1; $i++) {
                        if (!empty($random) && in_array($i, $random)) {
                            echo "<i style='color:gold' class='fa-solid fa-person px-0.5 py-0.5'></i>";
                            // Remove the element from $random
                            $key = array_search($i, $random);
                            unset($random[$key]);
                        } else {
                            echo "<i style='' class='fa-solid fa-person px-0.5 py-0.5'></i>";
                        }
                    }

                    ?>

                </div>
            </div>
        </body>

        </html>
        <?php
        $content = ob_get_contents();
        ob_end_clean();
        return $content;
        //   print_r($results);
    } else {
        // If form is not submitted, return an empty string
        return '<div class="items-center justify-center">No Result Found !</div>';
    }
}

// Register shortcode
add_shortcode('handle_delusion_calculator_form', 'handle_delusion_calculator_form');


?>
